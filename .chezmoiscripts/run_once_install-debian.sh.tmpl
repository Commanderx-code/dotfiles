#!/usr/bin/env bash
set -euo pipefail

echo "[chezmoi] Debian/Ubuntu/Zorin install script starting..."

# ------------
# APT packages
# ------------
sudo apt update

# Keep this list sane + broadly available on Debian-based distros
sudo apt install -y --no-install-recommends \
  git \
  curl \
  ca-certificates \
  wget \
  unzip \
  zip \
  tar \
  gzip \
  xz-utils \
  jq \
  ripgrep \
  fd-find \
  fzf \
  neovim \
  tmux \
  python3 \
  python3-pip \
  build-essential \
  pkg-config

# fd is "fdfind" on Debian/Ubuntu
if command -v fdfind >/dev/null 2>&1 && ! command -v fd >/dev/null 2>&1; then
  mkdir -p "$HOME/.local/bin"
  ln -sf "$(command -v fdfind)" "$HOME/.local/bin/fd"
fi

# -------------------
# Rust toolchain (for topgrade)
# -------------------
# Install rustup/cargo only if cargo isn't already present
if ! command -v cargo >/dev/null 2>&1; then
  echo "[chezmoi] Installing rustup (for cargo/topgrade)..."
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  # shellcheck disable=SC1090
  source "$HOME/.cargo/env"
fi

# -------------------
# topgrade (via cargo)
# -------------------
if command -v cargo >/dev/null 2>&1; then
  if ! command -v topgrade >/dev/null 2>&1; then
    echo "[chezmoi] Installing topgrade via cargo..."
    cargo install topgrade
  else
    echo "[chezmoi] topgrade already installed."
  fi
else
  echo "[chezmoi] cargo not available; skipping topgrade install."
fi

echo "[chezmoi] Debian/Ubuntu/Zorin install script complete."
