#!/usr/bin/env bash
set -euo pipefail

APPDIR="$HOME/Applications"
OUT="$APPDIR/Joplin.AppImage"
TMP="$(mktemp -d)"
trap 'rm -rf "$TMP"' EXIT

url="$(
  curl -fsSL "https://api.github.com/repos/laurent22/joplin/releases/latest" |
  jq -r '.assets[] | select(.name | test("AppImage$")) | .browser_download_url' |
  head -n1
)"

if [[ -z "${url:-}" ]]; then
  echo "Could not find Joplin AppImage URL."
  exit 1
fi

echo "Downloading: $url"
curl -fL "$url" -o "$TMP/Joplin.AppImage"
chmod +x "$TMP/Joplin.AppImage"

mkdir -p "$APPDIR"
mv -f "$TMP/Joplin.AppImage" "$OUT"

echo "Updated Joplin -> $OUT"
